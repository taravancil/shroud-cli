#!/usr/bin/env node
// native

// external
import {red} from 'chalk'
import minimist from 'minimist'
import inquirer from 'inquirer'

// lib
import commands from '../lib/commands/index'
import help from '../lib/help'
import usage from '../lib/usage'

const argv = minimist(process.argv.slice(2))

if (argv.help || argv.h) {
  usage()
}

// Map constructor turns arrays into key value pairs
const aliases = new Map([
  ['ls', 'list'],
  ['rm', 'remove']
])

// default command is help
let command = argv._[0] || 'help'

// if the command is an alias, redefine it
if (aliases.has(command)) {
  command = aliases.get(command)
}

const requiresPassword = command === 'show'
let password = argv.password || argv.p

if (!commands.has(command)) {
  console.log(red(`Error: ${command} is not a valid command\n`))
  usage()
  process.exit(1)
}

// get the command object
command = commands.get(command)
run(command)

async function run (command) {
  if (requiresPassword && !password) {
    password = await inquirer.prompt([
      { type: 'password',
        name: 'password',
        message: 'Enter your master password:'
      }])
    argv.password = password.password
  }
  command.run(argv)
}

